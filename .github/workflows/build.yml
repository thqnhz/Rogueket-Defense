name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip cmake ninja-build pkg-config libasound2-dev libx11-dev libxrandr-dev libxi-dev libgl1-mesa-dev libglu1-mesa-dev libxcursor-dev libxinerama-dev libwayland-dev libxkbcommon-dev libx11-xcb-dev libfontenc-dev libice-dev libsm-dev libxau-dev libxaw7-dev libxcomposite-dev libxdamage-dev libxmu-dev libxmuu-dev libxpm-dev libxres-dev libxss-dev libxtst-dev libxv-dev libxxf86vm-dev libxcb-glx0-dev libxcb-render-util0-dev libxcb-xkb-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev libxcb-randr0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-dri3-dev libxcb-cursor-dev libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev libxcb-composite0-dev libxcb-ewmh-dev libxcb-res0-dev

    - name: Install dependencies (MacOS)
      if: runner.os == 'macOS'
      run: |
        brew install python cmake ninja --quiet

    - name: Install 7zip (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install -y 7zip

    - name: Install Conan
      run: |
        python -m pip install conan

    - name: Install game dependencies
      run: |
        conan profile detect --force
        conan install . --build=missing -s build_type=Release -s compiler.cppstd=23

    - name: Cache conan
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-${{ runner.os }}-${{ hashFiles('conanfile.txt') }}

    - name: Config cmake
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          cmake --preset conan-default
        else
          cmake --preset conan-release
        fi

    - name: Package sources
      if: matrix.os == 'ubuntu-22.04'
      run: |
        git archive --format=tar.gz --prefix=RogueketDefense-${{ github.ref_name }}/ -o RogueketDefense-sources.tar.gz HEAD

    - name: Build
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          cmake --build --preset conan-default
        else
          cmake --build --preset conan-release
        fi

    - name: Package binary
      run: |
        mkdir -p dist
        cp LICENSE dist/
        cp -r assets dist/ || true
        cp build/Release/RogueketDefense* dist/ || true
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          7z a RogueketDefense-${{ matrix.os }}.zip dist/*
        else
          tar -czf RogueketDefense-${{ matrix.os }}.tar.gz -C dist .
        fi

    - name: Get changelog
      id: changelog
      shell: bash
      run: |
        {
          echo 'msg<<EOF'
          git log -1 --pretty=%B
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        body: ${{ steps.changelog.outputs.msg }}
        files: |
          RogueketDefense-sources.tar.gz
          RogueketDefense-*.zip
          RogueketDefense-*.tar.gz

