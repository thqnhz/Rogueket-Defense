name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2022, macos-14]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip cmake ninja-build pkg-config

    - name: Install dependencies (MacOS)
      if: runner.os == 'macOS'
      run: |
        brew install python cmake ninja --no-progress

    - name: Install 7zip (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install -y 7zip

    - name: Install Conan
      run: |
        python -m pip install conan
      
    - name: Conan Profile detection
      run: |
        conan profile detect --force

    - name: Cache conan
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-${{ runner.os }}-${{ hashFiles('conanfile.txt') }}

    - name: Install game dependencies
      run: |
        conan install . --build=missing -s build_type=Release

    - name: Config cmake
      run: |
        cmake --preset conan-release

    - name: Package sources
      if: matrix.os == 'ubuntu-22.04'
      run: |
        git archive --format=tar.gz --prefix=RogueketDefense-${{ github.ref_name }}/ -o RogueketDefense-sources.tar.gz HEAD

    - name: Build
      run: |
        cmake --build --preset conan-release

    - name: Package binary
      run: |
        mkdir -p dist
        cp LICENSE dist/
        cp -r assets dist/ || true
        cp build/Release/RogueketDefense* dist/ || true
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          7z a RogueketDefense-${{ matrix.os }}.zip dist/*
        else
          tar -czf RogueketDefense-${{ matrix.os }}.tar.gz -C dist .
        fi

    - name: Get changelog
      id: changelog
      shell: bash
      run: |
        {
          echo 'msg<<EOF'
          git log -1 --pretty=%B
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        body: ${{ steps.changelog.outputs.msg }}
        files: |
          RogueketDefense-sources.tar.gz
          RogueketDefense-*.zip
          RogueketDefense-*.tar.gz

